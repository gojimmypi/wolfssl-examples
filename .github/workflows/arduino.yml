name: Arduino CI Build (3 of 4) Latest wolfSSL for Local Examples

#
# Test local Arduino examples with clone of LATEST github master branch wolfssl
#
# These 4 workflows across 3 repos are interdependent for the current $REPO_OWNER:
#
# Arduino CI Build 1: https://github.com/$REPO_OWNER/wolfssl               #  /.github/workflows/arduino.yml
#   - Builds Arduino library from local clone of wolfssl master branch
#   - Fetches examples from https://github.com/$REPO_OWNER/wolfssl-examples
#
# Arduino CI Build 2: https://github.com/$REPO_OWNER/wolfssl-examples      #  /.github/workflows/arduino-release.yml
#    - Tests examples based on latest published release of Arduino library, NOT latest on wolfssl github.
#    - Should be identical to Arduino CI Build 3 in every way but wolfssl install.
#    - Copies only compile script from wolfssl-examples
#    - Builds local examples
#    - No other repos used
#
# THIS Arduino CI Build 3: https://github.com/$REPO_OWNER/wolfssl-examples #  /.github/workflows/arduino.yml
#   - Fetches current wolfSSL from https://github.com/$REPO_OWNER/wolfssl
#   - Creates an updated Arduino library
#   - Compiles local examples
#   - Contains the source of `compile-all-examples.sh` and respective board-list.txt
#
# Arduino CI Build 4: https://github.com/$REPO_OWNER/Arduino-wolfssl       #  /.github/workflows/arduino.yml
#    - Assembles and installs an updated Arduino wolfssl library from LOCAL wolfssl master source
#    - Copies only compile script copied from wolfssl-examples
#    - Builds local examples
#    - No other repos used
#
#
#                                   ** NOTE TO MAINTAINERS **
#
#           Consider using winmerge or similar tool to keep the 4 arduino[-release].yml files in relative sync.
#           Although there are some specific differences, most of the contents are otherwise identical.
#
# See https://github.com/wolfSSL/Arduino-wolfSSL
#
# To test locally:
# cd [your WOLFSSL_ROOT], e.g. cd /mnt/c/workspace/wolfssl-$USER
# [optional checkout]     e.g. git checkout tags/v5.8.4-stable
# pushd ./IDE/ARDUINO
# export ARDUINO_ROOT="$HOME/Arduino/libraries"
# ./wolfssl-arduino.sh INSTALL
# cd [your WOLFSSL_EXAMPLES_ROOT] e.g. /mnt/c/workspace/wolfssl-examples-$USER
#

# START OF COMMON SECTION
on:
  push:
    branches: [ '**', 'master', 'main', 'release/**' ]
    paths:
      # Specific to this Arduino CI Build (3 of 4)
      - 'Arduino/**'
      - '.github/workflows/arduino.yml'
  pull_request:
    branches: [ '**' ]
    paths:
      # Specific to this Arduino CI Build (3 of 4)
      - 'Arduino/**'
      - '.github/workflows/arduino.yml'
  workflow_dispatch:

concurrency:
  # Same branch push cancels other jobs. Other PR branches untouched

  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# END OF COMMON SECTION

env:
  ADDITIONAL_URLS: |
    https://www.pjrc.com/teensy/package_teensy_index.json
    https://arduino.esp8266.com/stable/package_esp8266com_index.json

  PLATFORMS: |
    - name: "esp32:esp32"
    - name: "esp8266:esp8266"
    - name: "teensy:avr"
    - name: "arduino:avr"
    - name: "arduino:sam"
    - name: "arduino:samd"
    - name: "arduino:mbed_nano"
    - name: "arduino:mbed_portenta"
    - name: "arduino:mbed_edge"
    - name: "arduino:renesas_uno"

  ARDUINO_DATA_DIR: $HOME/.arduino15
  ARDUINO_DOWNLOADS_DIR: $HOME/.arduino15/staging
  ARDUINO_BUILD_CACHE: $HOME/.cache/arduino

jobs:

  # Prepare and cache install
  prepare-cache:
    name: Prepare Arduino cache
    runs-on: ubuntu-latest
    outputs:
      wolfsha: ${{ steps.wolfsha.outputs.sha }}
    env:
      REPO_OWNER: ${{ github.repository_owner }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Arduino CLI
        uses: arduino/setup-arduino-cli@v2
        with:
          version: "1.x"

      - name: Configure Arduino CLI and preinstall platforms
        run: |
          arduino-cli config init
          arduino-cli config set build_cache.path "$ARDUINO_BUILD_CACHE"
          while IFS= read -r url; do
            [ -n "$url" ] && arduino-cli config add board_manager.additional_urls "$url"
          done <<EOF
          $ADDITIONAL_URLS
          EOF
          arduino-cli core update-index
          names=$(echo "${PLATFORMS}" | grep -E 'name:' | awk -F\" '{print $2}')
          for p in $names; do
            arduino-cli core install "$p"
          done

      - name: Ensure ARDUINO_ROOT exists
        run: |
          echo "ARDUINO_ROOT=$HOME/Arduino/libraries" >> "$GITHUB_ENV"
          mkdir -p "$HOME/Arduino/libraries"

      # Optionally let callers set a ref; fallback to master
      - name: Resolve wolfSSL ref
        id: wolfref
        run: |
          REF="${WOLFSSL_REF:-master}"
          echo "ref=$REF" >> "$GITHUB_OUTPUT"

      # Get commit SHA without cloning (heads, tags, or exact)
      - name: Resolve wolfSSL SHA (no clone)
        id: wolfsha-peek
        env:
          OWNER: ${{ github.repository_owner }}
        run: |
          set -e
          REF="${{ steps.wolfref.outputs.ref }}"
          URL="https://github.com/${OWNER}/wolfssl.git"

          # Try exact ref first; then heads; then tags; then annotated tag deref
          sha="$(git ls-remote "$URL" "$REF"           | awk '{print $1}')"
          [ -z "$sha" ] && sha="$(git ls-remote "$URL" "refs/heads/$REF" | awk '{print $1}')"
          [ -z "$sha" ] && sha="$(git ls-remote "$URL" "refs/tags/$REF"  | awk '{print $1}')"
          [ -z "$sha" ] && sha="$(git ls-remote "$URL" "refs/tags/$REF^{}" | awk '{print $1}')"

          if [ -z "$sha" ]; then
            echo "Could not resolve ref '$REF' in ${OWNER}/wolfssl" >&2
            exit 1
          fi

          echo "sha=${sha:0:7}" >> "$GITHUB_OUTPUT"
          echo "full_sha=$sha"  >> "$GITHUB_OUTPUT"
          echo "sha=${sha:0:7}"
          echo "full_sha=$sha"

      # Specific to Arduino CI Build (3 of 4) Latest wolfSSL for Local Examples
      - name: Shallow clone wolfssl
        run: |
          # Clone the wolfssl to use for example build

          rm -rf "./wolfssl"
          git clone --depth 1 https://github.com/$REPO_OWNER/wolfssl.git

          # Assign your PR branch for testing here:
          THIS_PR_BRANCH=""

          echo "REPO_OWNER=$REPO_OWNER"

          # If a branch is assigned for current repo user, checkout
          if [ -z "$THIS_PR_BRANCH" ]; then
            echo "Assign your PR branch name for testing"
          else
              # fetch open PR changes
              pushd wolfssl
              git remote add $REPO_OWNER https://github.com/$REPO_OWNER/wolfssl.git
              git fetch --depth 1 "$REPO_OWNER" "$THIS_PR_BRANCH"
            git checkout "$THIS_PR_BRANCH"
            popd
          fi
          # end wolfssl source

      # Get the SHA value of the latest version of wolfSSL for cache
      - name: Get wolfSSL commit
        id: wolfsha
        if: steps.restore-wolfssl.outputs.cache-hit != 'true'
        run: echo "sha=$(git -C wolfssl rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"

      # Attempt to restore the Arduino wolfssl library
      - name: Restore cached wolfSSL library
        id: restore-wolfssl
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.ARDUINO_ROOT }}/wolfssl
          key: wolfssl-lib-${{ runner.os }}-${{ steps.wolfsha.outputs.sha }}-${{ hashFiles('wolfssl/IDE/ARDUINO/wolfssl-arduino.sh') }}-${{ hashFiles('Arduino/sketches/**') }}

      # Specific to Arduino CI Build (3 of 4) Latest wolfSSL for Local Examples
      # We cache only THIS most recent install of wolfSSL (not a release)
      - name: Cache wolfSSL Arduino library
        id: cache-wolfssl
        uses: actions/cache@v4
        with:
          path: ${{ env.ARDUINO_ROOT }}/wolfssl
          key: wolfssl-lib-${{ runner.os }}-${{ steps.wolfsha.outputs.sha }}-${{ hashFiles('wolfssl/IDE/ARDUINO/wolfssl-arduino.sh') }}-${{ hashFiles('Arduino/sketches/**') }}

      - name: Install wolfSSL Arduino library
        if: steps.cache-wolfssl.outputs.cache-hit != 'true'
        run: |
          # Install wolfssl via wolfssl-arduino.sh install script

          echo "Installing wolfSSL Arduino library (no cache hit)."
          rm -rf "$ARDUINO_ROOT/wolfssl"

          # Even though the examples are in this library, we'll test as installed for library publishing.
          # When WOLFSSL_EXAMPLES_ROOT is set, the examples will be copied from that path to the published library.
          # WOLFSSL_EXAMPLES_ROOT is the repo root, not example directory location (./Arduino/sketches) within.
          export WOLFSSL_EXAMPLES_ROOT=$(realpath "./")

          # Confirm ARDUINO_ROOT to install the wolfSSL library, see above "Set job environment variables"
          echo "PWD                   = $PWD"
          echo "ARDUINO_ROOT          = $ARDUINO_ROOT"
          echo "WOLFSSL_EXAMPLES_ROOT = $WOLFSSL_EXAMPLES_ROOT"
          ls ./Arduino/sketches

          if [ -z "$WOLFSSL_EXAMPLES_ROOT" ]; then
            echo "$ICON_FAIL ERROR: Tests should be performed on in-place examples. WOLFSSL_EXAMPLES_ROOT is blank"
          fi

          # The install script is in the wolfssl repo, in /IDE/ARDUINO directory.
          # Only explicit source code is copied to the Arduino library.
          # Edit wolfssl-arduino.sh as needed for new examples.
          pushd ./wolfssl/IDE/ARDUINO
            chmod +x ./wolfssl-arduino.sh
            bash     ./wolfssl-arduino.sh INSTALL  # Install wolfSSL as Arduino library in ARDUINO_ROOT
          popd

          echo "Examples installed in $ARDUINO_ROOT/wolfssl/examples"
          ls "$ARDUINO_ROOT/wolfssl/examples" -al

          # End Install wolfSSL Arduino library

      - name: Freeze core and library versions for cache key
        run: |
          mkdir -p .ci
          arduino-cli core list --format json > .ci/arduino-cores.lock
          arduino-cli lib list --format json > .ci/arduino-libs.lock

      - name: Save Arduino caches
        uses: actions/cache/save@v4
        with:
          path: |
            ${{ env.ARDUINO_DATA_DIR }}
            ${{ env.ARDUINO_DOWNLOADS_DIR }}
            ${{ env.ARDUINO_BUILD_CACHE }}
          key: arduino-${{ runner.os }}-${{ hashFiles('.ci/arduino-cores.lock', '.ci/arduino-libs.lock') }}

  build:
    name: Latest Compile (${{ matrix.fqbn }})
#    if: github.repository_owner == 'wolfssl'
    needs: prepare-cache
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      max-parallel: 6
      matrix:
        fqbn:
          - arduino:avr:ethernet
          - arduino:avr:leonardoeth
          - arduino:avr:mega
          - arduino:avr:nano
          - arduino:avr:uno
          - arduino:avr:yun
          - arduino:samd:mkrwifi1010
          - arduino:samd:mkr1000
          - arduino:samd:mkrfox1200
          - arduino:mbed_edge:edge_control
          - arduino:mbed_nano:nanorp2040connect
          - arduino:mbed_portenta:envie_m7
          - arduino:mbed_portenta:portenta_x8
          - arduino:renesas_uno:unor4wifi
          - arduino:sam:arduino_due_x
          - arduino:samd:arduino_zero_native
          - arduino:samd:tian
          - esp32:esp32:esp32
          - esp32:esp32:esp32s2
          - esp32:esp32:esp32s3
          - esp32:esp32:esp32c3
          - esp32:esp32:esp32c6
          - esp32:esp32:esp32h2
          - esp8266:esp8266:generic
          - teensy:avr:teensy40

          # Not yet supported, not in standard library
          # - esp32:esp32:nano_nora

          # End strategy matrix
    env:
      REPO_OWNER: ${{ github.repository_owner }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Arduino CLI
        uses: arduino/setup-arduino-cli@v2
        with:
          version: "1.x"

      - name: Confirm Arduino CLI install
        run: arduino-cli version

      - name: Restore Arduino caches
        uses: actions/cache/restore@v4
        with:
          path: |
            ${{ env.ARDUINO_DATA_DIR }}
            ${{ env.ARDUINO_DOWNLOADS_DIR }}
            ${{ env.ARDUINO_BUILD_CACHE }}
          key: arduino-${{ runner.os }}-${{ hashFiles('.ci/arduino-cores.lock', '.ci/arduino-libs.lock') }}
          restore-keys: |
            arduino-${{ runner.os }}-

      - name: Set job environment variables
        run: |
          # Script to assign some common environment variables after everything is installed

          ICON_OK=$(printf "\xE2\x9C\x85")
          ICON_FAIL=$(printf "\xE2\x9D\x8C")

          echo "GITHUB_WORK=$(realpath           "$GITHUB_WORKSPACE/../..")"  >> "$GITHUB_ENV"
          echo "ARDUINO_ROOT=$(realpath          "$HOME/Arduino/libraries")"  >> "$GITHUB_ENV"

          # Show repo-specific location of examples:
          echo "WOLFSSL_EXAMPLES_ROOT=$(realpath "./Arduino/sketches")"       >> "$GITHUB_ENV"

          # Show predefined summary:
          echo "GITHUB_WORKSPACE      = $GITHUB_WORKSPACE"

          # Show assigned build:env values (e.g. "wolfssl", "gojimmpi" or other owners):
          echo "REPO_OWNER            = $REPO_OWNER"

          # Show our custom values:
          echo "GITHUB_WORK           = $GITHUB_WORK"
          echo "ARDUINO_ROOT          = $ARDUINO_ROOT"

          # WOLFSSL_EXAMPLES_ROOT is the report root, not example location
          echo "WOLFSSL_EXAMPLES_ROOT = $WOLFSSL_EXAMPLES_ROOT"

      - name: Compute cache key parts
        id: parts
        shell: bash
        run: |
          # From FQBN "vendor:arch:board" get "vendor:arch"
          CORE_ID="$(echo "${{ matrix.fqbn }}" | awk -F: '{print $1 ":" $2}')"
          echo "CORE_ID=$CORE_ID" >> "$GITHUB_OUTPUT"

          # Also expose vendor only for broad fallbacks
          VENDOR="$(echo "$CORE_ID" | cut -d: -f1)"
          echo "VENDOR=$VENDOR" >> "$GITHUB_OUTPUT"

      - name: Show wolfssl-examples
        run: |
          # The examples are local in this wolfssl-example repo, but should have been copied to library, above
          ls ./Arduino/sketches

          # end Show wolfssl-examples

      - name: List installed Arduino libraries
        run: arduino-cli lib list

      # This will fail with Arduino published wolfSSL v5.7.6 and older
      # as the examples moved. See https://github.com/wolfSSL/wolfssl/pull/8514
      #
      - name: Compile Arduino Sketches for Various Boards
        run: |
          # Call the compile-all-examples.sh script to compile all the examples for each of the fqbn names in the local copy of board_list.txt

          echo "Current directory     = $PWD"
          echo "ARDUINO_ROOT          = $ARDUINO_ROOT"
          echo "WOLFSSL_EXAMPLES_ROOT = $WOLFSSL_EXAMPLES_ROOT"
          echo "FQBN                  = ${{ matrix.fqbn }}"

          echo "Change directory to Arduino examples..."
          pushd ./Arduino/sketches
            chmod +x ./compile-all-examples.sh

            # The script expects all the examples to be in the current directory.
            # So copy from local directory to newly instlled wolfssl arduino library to compile there.
            cp ./compile-all-examples.sh "$ARDUINO_ROOT/wolfssl/examples/compile-all-examples.sh"
            cp ./board_list.txt          "$ARDUINO_ROOT/wolfssl/examples/board_list.txt"

            # Compile the Arduino library examples in-place
            pushd "$ARDUINO_ROOT/wolfssl/examples/"
              echo "PWD=$PWD"
              ./compile-all-examples.sh ./board_list.txt "${{ matrix.fqbn }}"
            popd
          popd

          # End Compile Arduino Sketches for Various Boards